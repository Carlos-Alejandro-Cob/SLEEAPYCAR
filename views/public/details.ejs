<%- include('header') %>

    <div class="row justify-content-center w-100">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-box me-2"></i>Envío #<%= envio.ID_Envio %>
                    </h5>
                    <a href="/rastreo" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                </div>
                <div class="card-body p-4">
                    <!-- Status Steps -->
                    <div class="position-relative m-4">
                        <div class="progress" style="height: 2px;">
                            <div class="progress-bar" role="progressbar"
                                style="width: <%= envio.Estado_Envio === 'Entregado' ? '100%' : (envio.Estado_Envio === 'En Ruta' ? '50%' : '0%') %>;">
                            </div>
                        </div>
                        <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-primary rounded-pill"
                            style="width: 2rem; height:2rem;">1</div>
                        <div class="position-absolute top-0 start-50 translate-middle btn btn-sm <%= envio.Estado_Envio !== 'Pendiente' ? 'btn-primary' : 'btn-secondary' %> rounded-pill"
                            style="width: 2rem; height:2rem;">2</div>
                        <div class="position-absolute top-0 start-100 translate-middle btn btn-sm <%= envio.Estado_Envio === 'Entregado' ? 'btn-primary' : 'btn-secondary' %> rounded-pill"
                            style="width: 2rem; height:2rem;">3</div>

                        <div class="d-flex justify-content-between mt-2 text-muted small">
                            <span>Pendiente</span>
                            <span>En Ruta</span>
                            <span>Entregado</span>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Details -->
                    <div class="row g-3">
                        <div class="col-6">
                            <small class="text-muted d-block">Destinatario</small>
                            <strong>
                                <%= envio.Nombre_Destinatario %>
                            </strong>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted d-block">Estado Actual</small>
                            <span class="badge bg-primary">
                                <%= envio.Estado_Envio %>
                            </span>
                        </div>
                        <div class="col-12">
                            <small class="text-muted d-block">Dirección</small>
                            <span>
                                <%= envio.Direccion_Completa %>
                            </span>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <% if (envio.precio> 0) { %>
                        <div class="mt-4 p-3 bg-light rounded border">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="h5 mb-0">Total a Pagar:</span>
                                <span class="h4 mb-0 fw-bold text-success">$<%= parseFloat(envio.precio).toFixed(2) %>
                                </span>
                            </div>

                            <% if (envio.estado_pago==='Pagado' ) { %>
                                <div class="alert alert-success mb-0 text-center">
                                    <i class="fas fa-check-circle me-2"></i>¡Este envío ya ha sido pagado!
                                </div>
                                <% } else { %>
                                    <div class="d-grid gap-2">
                                        <!-- PayPal Button Container -->
                                        <div id="paypal-button-container"></div>

                                        <!-- Mercado Pago Button -->
                                        <div id="wallet_container"></div>
                                    </div>
                                    <% } %>
                        </div>
                        <% } else { %>
                            <!-- Debug info for user if price is 0 -->
                            <div class="mt-4 alert alert-info text-center">
                                <small>Este envío no tiene un precio asignado para pago en línea.</small>
                            </div>
                            <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts for Payment Gateways -->
    <% if (envio.precio> 0 && envio.estado_pago !== 'Pagado') { %>
        <!-- PayPal SDK -->
        <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=MXN"></script>
        <script>
            paypal.Buttons({
                createOrder: function (data, actions) {
                    return fetch('/api/pagos/paypal/create-order', {
                        method: 'post',
                        headers: { 'content-type': 'application/json' },
                        body: JSON.stringify({
                            orderId: '<%= envio._id %>',
                            amount: '<%= envio.precio %>'
                        })
                    }).then(function (res) {
                        return res.json();
                    }).then(function (orderData) {
                        return orderData.id;
                    });
                },
                onApprove: function (data, actions) {
                    return fetch('/api/pagos/paypal/capture-order', {
                        method: 'post',
                        headers: { 'content-type': 'application/json' },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            envioId: '<%= envio._id %>'
                        })
                    }).then(function (res) {
                        return res.json();
                    }).then(function (orderData) {
                        window.location.reload();
                    });
                }
            }).render('#paypal-button-container');
        </script>

        <!-- Mercado Pago SDK -->
        <script src="https://sdk.mercadopago.com/js/v2"></script>
        <script>
            const mp = new MercadoPago('<%= mpPublicKey %>');

            // Create Preference on load
            fetch('/api/pagos/mercadopago/create-preference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    envioId: '<%= envio._id %>',
                    title: 'Envío #<%= envio.ID_Envio %>',
                    price: <%= envio.precio %>
            })
            })
                .then(response => response.json())
                .then(preference => {
                    mp.bricks().create("wallet", "wallet_container", {
                        initialization: {
                            preferenceId: preference.id,
                        },
                    });
                })
                .catch(error => console.error(error));
        </script>
        <% } %>

            <%- include('footer') %>