<%- include('../layouts/header', { ...locals, title: (isEdit ? 'Editar Incidencia' : 'Nueva Incidencia' )
    + ' - SLEE APYCAR' }) %>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="h3 mb-2">
                        <%= isEdit ? 'Editar Incidencia' : 'Nueva Incidencia' %>
                    </h1>
                    <p class="text-muted mb-0">
                        <%= isEdit ? 'Modifica los detalles de la incidencia'
                            : 'Reporta una nueva incidencia con los detalles y una foto de evidencia' %>
                    </p>
                </div>
                <a href="/admin/incidencias" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-body">
                    <form
                        action="/admin/incidencias<%= isEdit ? '/' + incidencia.id_incidencia + '?_method=PUT' : '' %>"
                        method="POST" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="codigo_envio" class="form-label">ID de Envío</label>
                                <input type="text" class="form-control" id="codigo_envio" name="codigo_envio"
                                    value="<%= incidencia ? incidencia.codigo_envio : '' %>"
                                    placeholder="E-2025/10/26-01" 
                                    pattern="^E-\d{4}\/\d{2}\/\d{2}-\d{2}$"
                                    title="Formato requerido: E-yyyy/mm/dd-NN (ejemplo: E-2025/10/26-01)"
                                    required>
                                <div class="form-text">Formato: E-yyyy/mm/dd-NN (ejemplo: E-2025/10/26-01)</div>
                                <div class="invalid-feedback" id="codigo_envio-error"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="id_usuario_reporta_fk" class="form-label">ID Usuario Reporta</label>
                                <input type="number" class="form-control" id="id_usuario_reporta_fk"
                                    name="id_usuario_reporta_fk"
                                    value="<%= incidencia ? incidencia.id_usuario_reporta_fk : '' %>" required>
                            </div>

                            <div class="col-12">
                                <label for="tipo_incidencia" class="form-label">Tipo de Incidencia</label>
                                <input type="text" class="form-control" id="tipo_incidencia" name="tipo_incidencia"
                                    value="<%= incidencia ? incidencia.tipo_incidencia : '' %>" required>
                            </div>

                            <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" name="observaciones"
                                    rows="4"><%= incidencia ? incidencia.observaciones : '' %></textarea>
                            </div>

                            <div class="col-12">
                                <label for="foto_evidencia" class="form-label">Foto de Evidencia</label>
                                <% if (isEdit && incidencia.url_foto_evidencia) { %>
                                    <div class="mb-2">
                                        <img src="<%= incidencia.url_foto_evidencia %>" alt="Evidencia actual"
                                            style="max-height: 150px; border-radius: 4px;">
                                        <p class="text-muted small">Imagen actual</p>
                                    </div>
                                    <% } %>
                                        <input type="file" class="form-control" id="foto_evidencia"
                                            name="foto_evidencia" accept="image/jpeg, image/png">
                                        <div class="form-text" style="font-size: 0.8125rem; color: var(--text-light);">
                                            Solo se permiten archivos JPG/PNG. <%= isEdit
                                                ? 'Deja en blanco para mantener la imagen actual.' : '' %>
                                        </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <a href="/admin/incidencias" class="btn btn-outline-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                <%= isEdit ? 'Actualizar' : 'Reportar' %> Incidencia
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <% if (isEdit) { %>
                <div class="card mt-4 border-danger">
                    <div class="card-body">
                        <h5 class="mb-2" style="color: #dc2626;">Zona de Peligro</h5>
                        <p class="text-muted mb-3" style="font-size: 0.875rem;">Esta acción no se puede deshacer.</p>
                        <form action="/admin/incidencias/<%= incidencia.id_incidencia %>?_method=DELETE" method="POST"
                            class="d-inline"
                            onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta incidencia?');">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="fas fa-trash me-2"></i>Eliminar Incidencia
                            </button>
                        </form>
                    </div>
                </div>
                <% } %>
        </div>
    </div>

    <script>
        // Validación del formato de código de envío
        document.addEventListener('DOMContentLoaded', function() {
            const codigoInput = document.getElementById('codigo_envio');
            const form = codigoInput.closest('form');
            const errorDiv = document.getElementById('codigo_envio-error');

            // Validación en tiempo real
            codigoInput.addEventListener('input', function() {
                const codigo = this.value.trim();
                const formatoRegex = /^E-\d{4}\/\d{2}\/\d{2}-\d{2}$/;
                
                if (codigo && !formatoRegex.test(codigo)) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    errorDiv.textContent = 'Formato inválido. Debe ser E-yyyy/mm/dd-NN (ejemplo: E-2025/10/26-01)';
                } else if (codigo && formatoRegex.test(codigo)) {
                    // Validar fecha
                    const partes = codigo.match(/^E-(\d{4})\/(\d{2})\/(\d{2})-(\d{2})$/);
                    if (partes) {
                        const año = parseInt(partes[1]);
                        const mes = parseInt(partes[2]);
                        const dia = parseInt(partes[3]);
                        const fecha = new Date(año, mes - 1, dia);
                        
                        if (fecha.getFullYear() !== año || fecha.getMonth() !== mes - 1 || fecha.getDate() !== dia) {
                            this.classList.add('is-invalid');
                            this.classList.remove('is-valid');
                            errorDiv.textContent = 'La fecha en el código no es válida.';
                        } else {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                            errorDiv.textContent = '';
                        }
                    }
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                    errorDiv.textContent = '';
                }
            });

            // Validación al enviar el formulario
            form.addEventListener('submit', function(e) {
                const codigo = codigoInput.value.trim();
                const formatoRegex = /^E-\d{4}\/\d{2}\/\d{2}-\d{2}$/;
                
                if (!codigo || !formatoRegex.test(codigo)) {
                    e.preventDefault();
                    codigoInput.classList.add('is-invalid');
                    errorDiv.textContent = 'El código de envío debe tener el formato E-yyyy/mm/dd-NN (ejemplo: E-2025/10/26-01)';
                    codigoInput.focus();
                    return false;
                }

                // Validar fecha
                const partes = codigo.match(/^E-(\d{4})\/(\d{2})\/(\d{2})-(\d{2})$/);
                if (partes) {
                    const año = parseInt(partes[1]);
                    const mes = parseInt(partes[2]);
                    const dia = parseInt(partes[3]);
                    const fecha = new Date(año, mes - 1, dia);
                    
                    if (fecha.getFullYear() !== año || fecha.getMonth() !== mes - 1 || fecha.getDate() !== dia) {
                        e.preventDefault();
                        codigoInput.classList.add('is-invalid');
                        errorDiv.textContent = 'La fecha en el código no es válida.';
                        codigoInput.focus();
                        return false;
                    }
                }
            });
        });
    </script>

    <%- include('../layouts/footer') %>